async function t(){return await async function(){try{const t=localStorage.getItem("twitchToken");if(t){let n=await e(t);if(n&&n.login)return n.token=t,n;{const t=localStorage.getItem("refreshToken");if(t){if(!o.refreshUrl)throw new Error("No refresh endpoint set");const n=await fetch(`${o.refreshUrl}?token=${t}`).then(t=>t.json()),r=n.access_token,c=await e(r);if(c&&c.login)return localStorage.setItem("twitchToken",r),localStorage.setItem("refreshToken",n.refresh_token),c.token=r,c}}}}catch(t){console.error(t)}return null}()||await async function(){try{!function(){const t=new URLSearchParams(location.search).get("state"),e=window.localStorage.getItem("comfytwitch_nonce");if(t&&t!==e)throw new Error("Auth State did not match")}();const t=new URLSearchParams(location.search).get("code"),n=new URLSearchParams(location.hash.replace("#","")).get("access_token");if(t){if(!o.codeAuthUrl)throw new Error("No code grant endpoint set");const n=await fetch(`${o.codeAuthUrl}?code=${t}`).then(t=>t.json()),r=n.access_token,c=await e(r);if(c&&c.login){localStorage.setItem("twitchToken",r),localStorage.setItem("refreshToken",n.refresh_token);const t=window.location.href.split("?")[0];return window.location.replace(t),c.token=r,c}}else if(n){const t=await e(n);if(t&&t.login){localStorage.setItem("twitchToken",n);const e=window.location.href.split("#")[0];return window.location.replace(e),t.token=n,t}}}catch(t){console.error(t)}return null}()}async function e(t){return await fetch("https://id.twitch.tv/oauth2/validate",{headers:{Authorization:"OAuth "+t}}).then(t=>t.json()).catch(t=>({error:t}))}let o={UserId:0,User:"",ClientID:"",Token:"",Scopes:[],Logout:function(){localStorage.removeItem("twitchToken")},Login:function(t,e,o=["user:read:email"],n="token"){const r=function(){const t="0123456789ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvwxyz-_",e=[];return window.crypto.getRandomValues(new Uint8Array(32)).forEach(o=>e.push(t[o%t.length])),e.join("")}();window.localStorage.setItem("comfytwitch_nonce",r),window.location.href=`https://id.twitch.tv/oauth2/authorize?client_id=${t}&redirect_uri=${e}&response_type=${n}&scope=${encodeURIComponent(o.join(" "))}&state=${r}`},SetAuthEndpoint:function(t){o.codeAuthUrl=t},SetRefreshEndpoint:function(t){o.refreshUrl=t},Check:async function(e){let n=await t();return n?(o.ClientID=n.client_id,o.UserId=n.user_id,o.User=n.login,o.Token=n.token,o.Scopes=n.scopes):(o.Logout(),e&&(window.location.href=e)),n},GetUser:async function(t,e){return await fetch("https://api.twitch.tv/helix/users?id="+e,{headers:{"Client-ID":t,Authorization:"Bearer "+o.Token}}).then(t=>t.json()).then(t=>t.data.length>0?t.data[0]:{}).catch(t=>({error:t}))}};window.ComfyTwitch=o;